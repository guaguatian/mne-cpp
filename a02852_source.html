<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>MNE-CPP Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a class="site-logo" href="http://www.mne-cpp.org/" title="A Framework for Electrophysiology"><img alt="Logo" src="MNE-CPP_Doxygen_Logo.svg"/></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">MNE-CPP
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">A Framework for Electrophysiology</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_a6e4fee11f07c3b70486e88fe92cbbdc.html">applications</a></li><li class="navelem"><a class="el" href="dir_e446c6e1cb3fc1a93d99e5b33bb756bc.html">mne_scan</a></li><li class="navelem"><a class="el" href="dir_dff0cf57900fd280f21b02b063bc8d88.html">plugins</a></li><li class="navelem"><a class="el" href="dir_3cd05e200e0d8f32bf39d936e324bbef.html">noisereduction</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">noisereduction.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="a02852.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"></span><span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">// INCLUDES</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="a02855.html">noisereduction.h</a>&quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a00443.html">disp/viewers/scalingview.h</a>&gt;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a00419.html">disp/viewers/projectorsview.h</a>&gt;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a00317.html">disp/viewers/filtersettingsview.h</a>&gt;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;disp/viewers/filterdesignview.h&gt;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a00257.html">disp/viewers/compensatorview.h</a>&gt;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a00461.html">disp/viewers/spharasettingsview.h</a>&gt;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a01541.html">utils/filterTools/sphara.h</a>&gt;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a01583.html">utils/ioutils.h</a>&gt;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a01484.html">rtprocessing/rtfilter.h</a>&gt;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="a02219.html">scMeas/realtimemultisamplearray.h</a>&gt;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="a02849.html">FormFiles/noisereductionsetupwidget.h</a>&quot;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">// QT INCLUDES</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">// Eigen INCLUDES</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">// USED NAMESPACES</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03226.html">NOISEREDUCTIONPLUGIN</a>;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03204.html">SCMEASLIB</a>;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03167.html">UTILSLIB</a>;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03183.html">IOBUFFER</a>;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03164.html">DISPLIB</a>;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keyword">using namespace </span><a class="code" href="a03182.html">RTPROCESSINGLIB</a>;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">// DEFINE MEMBER METHODS</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">//=============================================================================================================</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;NoiseReduction::NoiseReduction()</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;: m_bIsRunning(false)</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;, m_pNoiseReductionInput(NULL)</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;, m_pNoiseReductionOutput(NULL)</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;, m_pNoiseReductionBuffer(<a class="code" href="a04783.html">CircularMatrixBuffer</a>&lt;double&gt;::SPtr())</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;, m_iMaxFilterTapSize(0)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;, m_bSpharaActive(false)</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;, m_bFilterActivated(false)</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;, m_bProjActivated(false)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;, m_bCompActivated(false)</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;, m_sCurrentSystem(<span class="stringliteral">&quot;VectorView&quot;</span>)</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;, m_pRTMSA(<a class="code" href="a05323.html">RealTimeMultiSampleArray</a>::SPtr(new <a class="code" href="a05323.html">RealTimeMultiSampleArray</a>()))</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;, m_pRtFilter(<a class="code" href="a03182.html">RTPROCESSINGLIB</a>::<a class="code" href="a04715.html">RtFilter</a>::SPtr::create())</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;, m_iMaxFilterLength(1)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;{</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keywordflow">if</span>(m_sCurrentSystem == <span class="stringliteral">&quot;BabyMEG&quot;</span>) {</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        m_iNBaseFctsFirst = 270;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        m_iNBaseFctsSecond = 105;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(m_sCurrentSystem == <span class="stringliteral">&quot;VectorView&quot;</span>) {</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        m_iNBaseFctsFirst = 102;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        m_iNBaseFctsSecond = 102;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        m_iNBaseFctsFirst = 0;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        m_iNBaseFctsSecond = 0;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        qDebug() &lt;&lt; <span class="stringliteral">&quot;Current system type not recognized.&quot;</span>;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    }</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;}</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;NoiseReduction::~NoiseReduction()</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;{</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span>(this-&gt;isRunning()) {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        stop();</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;}</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;QSharedPointer&lt;IPlugin&gt; NoiseReduction::clone()<span class="keyword"> const</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    QSharedPointer&lt;NoiseReduction&gt; pNoiseReductionClone(<span class="keyword">new</span> <a class="code" href="a05775.html">NoiseReduction</a>);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordflow">return</span> pNoiseReductionClone;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;}</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keywordtype">void</span> NoiseReduction::init()</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;{</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">// Input</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    m_pNoiseReductionInput = <a class="code" href="a05379.html#ac8fc3f9ee35cd2c8336cadb3e7c6f5df">PluginInputData&lt;RealTimeMultiSampleArray&gt;::create</a>(<span class="keyword">this</span>, <span class="stringliteral">&quot;NoiseReductionIn&quot;</span>, <span class="stringliteral">&quot;NoiseReduction input data&quot;</span>);</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    connect(m_pNoiseReductionInput.data(), &amp;PluginInputConnector::notify,</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            <span class="keyword">this</span>, &amp;NoiseReduction::update, Qt::DirectConnection);</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    m_inputConnectors.append(m_pNoiseReductionInput);</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="comment">// Output - Uncomment this if you don&#39;t want to send processed data (in form of a matrix) to other plugins.</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    m_pNoiseReductionOutput = <a class="code" href="a05391.html#a8223ab9c31dbedbff2f257c2efd8c67b">PluginOutputData&lt;RealTimeMultiSampleArray&gt;::create</a>(<span class="keyword">this</span>, <span class="stringliteral">&quot;NoiseReductionOut&quot;</span>, <span class="stringliteral">&quot;NoiseReduction output data&quot;</span>);</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    m_outputConnectors.append(m_pNoiseReductionOutput);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    QStringList slFlags;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    slFlags &lt;&lt; <span class="stringliteral">&quot;view&quot;</span> &lt;&lt; <span class="stringliteral">&quot;triggerdetection&quot;</span> &lt;&lt; <span class="stringliteral">&quot;scaling&quot;</span> &lt;&lt; <span class="stringliteral">&quot;colors&quot;</span>;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    m_pNoiseReductionOutput-&gt;data()-&gt;setDisplayFlags(slFlags);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// Quick control projectors</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    m_pProjectorsView = ProjectorsView::SPtr::create(QString(<span class="stringliteral">&quot;Plugin/%1/&quot;</span>).arg(this-&gt;getName()));</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    m_pProjectorsView-&gt;setObjectName(<span class="stringliteral">&quot;group_tab_Noise_SSP&quot;</span>);</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    m_pNoiseReductionOutput-&gt;data()-&gt;addControlWidget(m_pProjectorsView);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    connect(m_pProjectorsView.data(), &amp;ProjectorsView::projSelectionChanged,</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="keyword">this</span>, &amp;<a class="code" href="a05775.html#ad397190f9542af0984688a877b4dd952">NoiseReduction::updateProjection</a>);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="comment">// Quick control compensators</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    m_pCompensatorView = CompensatorView::SPtr::create(QString(<span class="stringliteral">&quot;Plugin/%1/&quot;</span>).arg(this-&gt;getName()));</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    m_pCompensatorView-&gt;setObjectName(<span class="stringliteral">&quot;group_tab_Noise_Comp&quot;</span>);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    m_pNoiseReductionOutput-&gt;data()-&gt;addControlWidget(m_pCompensatorView);</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    connect(m_pCompensatorView.data(), &amp;CompensatorView::compSelectionChanged,</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;           <span class="keyword">this</span>, &amp;<a class="code" href="a05775.html#a696b993789870eb5a68065bd9d086f2c">NoiseReduction::updateCompensator</a>);</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// Quick control filter</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    m_pFilterSettingsView = FilterSettingsView::SPtr::create(QString(<span class="stringliteral">&quot;Plugin/%1/&quot;</span>).arg(this-&gt;getName()));</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    m_pFilterSettingsView-&gt;setObjectName(<span class="stringliteral">&quot;group_tab_Noise_Filter&quot;</span>);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    m_pNoiseReductionOutput-&gt;data()-&gt;addControlWidget(m_pFilterSettingsView);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    connect(m_pFilterSettingsView-&gt;getFilterView().data(), &amp;FilterDesignView::filterChannelTypeChanged,</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            <span class="keyword">this</span>, &amp;<a class="code" href="a05775.html#af02e1e61ff114b41ea03b2e568651c5c">NoiseReduction::setFilterChannelType</a>);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    connect(m_pFilterSettingsView-&gt;getFilterView().data(), &amp;FilterDesignView::filterChanged,</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="keyword">this</span>, &amp;<a class="code" href="a05775.html#a2bc4d62aba9a93884af4da532620c885">NoiseReduction::setFilter</a>);</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    connect(m_pFilterSettingsView.data(), &amp;FilterSettingsView::filterActivationChanged,</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keyword">this</span>, &amp;<a class="code" href="a05775.html#a39d3e28ceef2b9c77e44a2a47a6f70fc">NoiseReduction::setFilterActive</a>);</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    this-&gt;setFilterActive(m_pFilterSettingsView-&gt;getFilterActive());</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="comment">// Quick control SPHARA settings</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    m_pSpharaSettingsView = SpharaSettingsView::SPtr::create();</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    m_pSpharaSettingsView-&gt;setObjectName(<span class="stringliteral">&quot;group_tab_Noise_SPHARA&quot;</span>);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    m_pNoiseReductionOutput-&gt;data()-&gt;addControlWidget(m_pSpharaSettingsView);</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    connect(m_pSpharaSettingsView.data(), &amp;SpharaSettingsView::spharaActivationChanged,</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            <span class="keyword">this</span>, &amp;NoiseReduction::setSpharaActive);</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    connect(m_pSpharaSettingsView.data(), &amp;SpharaSettingsView::spharaOptionsChanged,</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            <span class="keyword">this</span>, &amp;NoiseReduction::setSpharaOptions);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span>(!m_pNoiseReductionBuffer.isNull()) {</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        m_pNoiseReductionBuffer = <a class="code" href="a04783.html">CircularMatrixBuffer&lt;double&gt;::SPtr</a>();</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;}</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keywordtype">void</span> NoiseReduction::unload()</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;{</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;}</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordtype">bool</span> NoiseReduction::start()</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;{</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">//    //Check if the thread is already or still running. This can happen if the start button is pressed immediately after the stop button was pressed. In this case the stopping process is not finished yet but the start process is initiated.</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">//    if(this-&gt;isRunning())</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">//        QThread::wait();</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    m_bIsRunning = <span class="keyword">true</span>;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="comment">//Start thread</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    QThread::start();</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;}</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordtype">bool</span> NoiseReduction::stop()</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;{</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    m_bIsRunning = <span class="keyword">false</span>;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    m_pNoiseReductionBuffer-&gt;releaseFromPop();</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    m_pNoiseReductionBuffer-&gt;clear();</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    m_pNoiseReductionBuffer-&gt;clear();</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;}</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<a class="code" href="a05351.html#addfb10f54b9f7aaed5a12ad5665d8b5d">IPlugin::PluginType</a> NoiseReduction::getType()<span class="keyword"> const</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordflow">return</span> _IAlgorithm;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;}</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;QString NoiseReduction::getName()<span class="keyword"> const</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Noise Reduction&quot;</span>;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;}</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;QWidget* NoiseReduction::setupWidget()</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;{</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <a class="code" href="a05771.html">NoiseReductionSetupWidget</a>* setupWidget = <span class="keyword">new</span> <a class="code" href="a05771.html#a002b1b47fabdcea03a18b2272758ca87">NoiseReductionSetupWidget</a>(<span class="keyword">this</span>);<span class="comment">//widget is later distroyed by CentralWidget - so it has to be created everytime new</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordflow">return</span> setupWidget;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;}</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="keywordtype">void</span> NoiseReduction::update(<a class="code" href="a05299.html#ab0a022ec36c13e2f29d09aa4e08dc85d">SCMEASLIB::Measurement::SPtr</a> pMeasurement)</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;{</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    m_pRTMSA = pMeasurement.dynamicCast&lt;<a class="code" href="a05323.html">RealTimeMultiSampleArray</a>&gt;();</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keywordflow">if</span>(m_pRTMSA) {</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="comment">//Check if buffer initialized</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">if</span>(!m_pNoiseReductionBuffer) {</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            m_pNoiseReductionBuffer = <a class="code" href="a04783.html">CircularMatrixBuffer&lt;double&gt;::SPtr</a>(<span class="keyword">new</span> <a class="code" href="a04783.html">CircularMatrixBuffer&lt;double&gt;</a>(64, m_pRTMSA-&gt;getNumChannels(), m_pRTMSA-&gt;getMultiSampleArray()[0].cols()));</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        }</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <span class="comment">//Fiff information</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordflow">if</span>(!m_pFiffInfo) {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            m_pFiffInfo = m_pRTMSA-&gt;info();</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            <span class="comment">//Init the multiplication matrices</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            m_matSparseProjMult = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            m_matSparseCompMult = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            m_matSparseSpharaMult = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            m_matSparseProjCompMult = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            m_matSparseFull = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            m_matSparseProjMult.setIdentity();</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            m_matSparseCompMult.setIdentity();</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            m_matSparseSpharaMult.setIdentity();</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            m_matSparseProjCompMult.setIdentity();</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            m_matSparseFull.setIdentity();</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            <span class="comment">//Init output - Unocmment this if you also uncommented the m_pNoiseReductionOutput in the constructor above</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            m_pNoiseReductionOutput-&gt;data()-&gt;initFromFiffInfo(m_pFiffInfo);</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            m_pNoiseReductionOutput-&gt;data()-&gt;setMultiArraySize(1);</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            m_pNoiseReductionOutput-&gt;data()-&gt;setVisibility(<span class="keyword">true</span>);            </div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <span class="comment">//Init the filter</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            m_iMaxFilterTapSize = m_pRTMSA-&gt;getMultiSampleArray().first().cols();</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            m_pFilterSettingsView-&gt;getFilterView()-&gt;init(m_pFiffInfo-&gt;sfreq);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            m_pFilterSettingsView-&gt;getFilterView()-&gt;setWindowSize(m_iMaxFilterTapSize);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            m_pFilterSettingsView-&gt;getFilterView()-&gt;setMaxFilterTaps(m_iMaxFilterTapSize);</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            this-&gt;setFilterChannelType(m_pFilterSettingsView-&gt;getFilterView()-&gt;getChannelType());</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            m_pProjectorsView-&gt;setProjectors(m_pFiffInfo-&gt;projs);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            m_pCompensatorView-&gt;setCompensators(m_pFiffInfo-&gt;comps);</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        }</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        MatrixXd t_mat;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i = 0; i &lt; m_pRTMSA-&gt;getMultiArraySize(); ++i) {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            t_mat = m_pRTMSA-&gt;getMultiSampleArray()[i];</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            m_pNoiseReductionBuffer-&gt;push(&amp;t_mat);</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        }</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    }</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;}</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keywordtype">void</span> NoiseReduction::setSpharaActive(<span class="keywordtype">bool</span> state)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;{</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    m_mutex.lock();</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    m_bSpharaActive = state;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    m_mutex.unlock();</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;}</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordtype">void</span> NoiseReduction::setSpharaOptions(<span class="keyword">const</span> QString&amp; sSytemType,</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                                      <span class="keywordtype">int</span> nBaseFctsFirst,</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                                      <span class="keywordtype">int</span> nBaseFctsSecond)</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;{</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    m_mutex.lock();</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    m_iNBaseFctsFirst = nBaseFctsFirst;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    m_iNBaseFctsSecond = nBaseFctsSecond;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    m_sCurrentSystem = sSytemType;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    m_mutex.unlock();</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    createSpharaOperator();</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;}</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno"><a class="line" href="a05775.html#ad397190f9542af0984688a877b4dd952">  352</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#ad397190f9542af0984688a877b4dd952">NoiseReduction::updateProjection</a>(<span class="keyword">const</span> QList&lt;FIFFLIB::FiffProj&gt;&amp; projs)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;{</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">//  Update the SSP projector</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">if</span>(m_pFiffInfo) {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        m_mutex.lock();</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="comment">//If a minimum of one projector is active set m_bProjActivated to true so that this model applies the ssp to the incoming data</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        m_bProjActivated = <span class="keyword">false</span>;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">for</span>(qint32 i = 0; i &lt; projs.size(); ++i) {</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            <span class="keywordflow">if</span>(projs[i].active) {</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                m_bProjActivated = <span class="keyword">true</span>;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            }</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        }</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        MatrixXd matProj;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        FiffProj::make_projector(projs, m_pFiffInfo-&gt;ch_names, matProj, m_pFiffInfo-&gt;bads);</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="comment">//set columns of matrix to zero depending on bad channels indexes</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keywordflow">for</span>(qint32 j = 0; j &lt; m_pFiffInfo-&gt;bads.size(); ++j) {</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            <span class="keywordtype">int</span> index = m_pFiffInfo-&gt;ch_names.indexOf(m_pFiffInfo-&gt;bads.at(j));</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="keywordflow">if</span>(index &gt;= 0 &amp;&amp; index&lt;m_pFiffInfo-&gt;ch_names.size()) {</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                matProj.col(index).setZero();</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            }</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        }</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="comment">// Make proj sparse</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        qint32 nchan = this-&gt;m_pFiffInfo-&gt;nchan;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        qint32 i, k;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        <span class="keyword">typedef</span> Eigen::Triplet&lt;double&gt; T;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        std::vector&lt;T&gt; tripletList;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        tripletList.reserve(nchan);</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        tripletList.clear();</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        tripletList.reserve(matProj.rows()*matProj.cols());</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        <span class="keywordflow">for</span>(i = 0; i &lt; matProj.rows(); ++i) {</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            <span class="keywordflow">for</span>(k = 0; k &lt; matProj.cols(); ++k) {</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                <span class="keywordflow">if</span>(matProj(i,k) != 0) {</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    tripletList.push_back(T(i, k, matProj(i,k)));</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                }</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            }</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        }</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        m_matSparseProjMult = SparseMatrix&lt;double&gt;(matProj.rows(),matProj.cols());</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="keywordflow">if</span>(tripletList.size() &gt; 0)</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            m_matSparseProjMult.setFromTriplets(tripletList.begin(), tripletList.end());</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="comment">//Create full multiplication matrix</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        m_matSparseProjCompMult = m_matSparseProjMult * m_matSparseCompMult;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        m_matSparseFull = m_matSparseProjMult * m_matSparseCompMult;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        m_mutex.unlock();</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    }</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno"><a class="line" href="a05775.html#a696b993789870eb5a68065bd9d086f2c">  410</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#a696b993789870eb5a68065bd9d086f2c">NoiseReduction::updateCompensator</a>(<span class="keywordtype">int</span> to)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;{</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="comment">// Update the compensator</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span>(m_pFiffInfo)</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span>(to == 0) {</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            m_bCompActivated = <span class="keyword">false</span>;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            m_bCompActivated = <span class="keyword">true</span>;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        }</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;to&quot;&lt;&lt;to;</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;from&quot;&lt;&lt;from;</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;m_bCompActivated&quot;&lt;&lt;m_bCompActivated;</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <a class="code" href="a03891.html">FiffCtfComp</a> newComp;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        this-&gt;m_pFiffInfo-&gt;make_compensator(0, to, newComp);<span class="comment">//Do this always from 0 since we always read new raw data, we never actually perform a multiplication on already existing data</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        this-&gt;m_pFiffInfo-&gt;set_current_comp(to);</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        MatrixXd matComp = newComp.<a class="code" href="a03891.html#a59d3cc5600aa876c0f8bcfc3b31e4e65">data</a>-&gt;data;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="comment">// Make proj sparse</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        qint32 nchan = this-&gt;m_pFiffInfo-&gt;nchan;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        qint32 i, k;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keyword">typedef</span> Eigen::Triplet&lt;double&gt; T;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        std::vector&lt;T&gt; tripletList;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        tripletList.reserve(nchan);</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        tripletList.clear();</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        tripletList.reserve(matComp.rows()*matComp.cols());</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keywordflow">for</span>(i = 0; i &lt; matComp.rows(); ++i) {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            <span class="keywordflow">for</span>(k = 0; k &lt; matComp.cols(); ++k) {</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                <span class="keywordflow">if</span>(matComp(i,k) != 0) {</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                    tripletList.push_back(T(i, k, matComp(i,k)));</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            }</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        }</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        m_matSparseCompMult = SparseMatrix&lt;double&gt;(matComp.rows(),matComp.cols());</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="keywordflow">if</span>(tripletList.size() &gt; 0) {</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            m_matSparseCompMult.setFromTriplets(tripletList.begin(), tripletList.end());</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="comment">//Create full multiplication matrix</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        m_matSparseProjCompMult = m_matSparseProjMult * m_matSparseCompMult;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        m_matSparseFull = m_matSparseProjMult * m_matSparseCompMult;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    }</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;}</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="a05775.html#af02e1e61ff114b41ea03b2e568651c5c">  466</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#af02e1e61ff114b41ea03b2e568651c5c">NoiseReduction::setFilterChannelType</a>(QString sType)</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;{</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    m_sFilterChannelType = sType;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">//This version is for when all channels of a type are to be filtered (not only the visible ones).</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="comment">//Create channel filter list independent from channelNames</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    m_lFilterChannelList.resize(0);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_pFiffInfo-&gt;chs.size(); ++i) {</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">if</span>((m_pFiffInfo-&gt;chs.at(i).kind == FIFFV_MEG_CH || m_pFiffInfo-&gt;chs.at(i).kind == FIFFV_EEG_CH ||</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            m_pFiffInfo-&gt;chs.at(i).kind == FIFFV_EOG_CH || m_pFiffInfo-&gt;chs.at(i).kind == FIFFV_ECG_CH ||</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            m_pFiffInfo-&gt;chs.at(i).kind == FIFFV_EMG_CH)<span class="comment">/* &amp;&amp; !m_pFiffInfo-&gt;bads.contains(m_pFiffInfo-&gt;chs.at(i).ch_name)*/</span>) {</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            <span class="keywordflow">if</span>(m_sFilterChannelType == <span class="stringliteral">&quot;All&quot;</span>) {</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                m_lFilterChannelList.resize(m_lFilterChannelList.cols() + 1);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                m_lFilterChannelList[m_lFilterChannelList.cols() -1] = i;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs.at(i).ch_name.contains(m_sFilterChannelType)) {</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                m_lFilterChannelList.resize(m_lFilterChannelList.cols() + 1);</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                m_lFilterChannelList[m_lFilterChannelList.cols() -1] = i;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            }</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        }</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    }</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;}</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno"><a class="line" href="a05775.html#a2bc4d62aba9a93884af4da532620c885">  493</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#a2bc4d62aba9a93884af4da532620c885">NoiseReduction::setFilter</a>(<span class="keyword">const</span> <a class="code" href="a04755.html">FilterData</a>&amp; <a class="code" href="a04379.html">filterData</a>)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;{</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    m_filterData = filterData;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    m_iMaxFilterLength = 1;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keywordflow">if</span>(m_iMaxFilterLength &lt; m_filterData.m_iFilterOrder) {</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        m_iMaxFilterLength = m_filterData.<a class="code" href="a04755.html#a7ab40d383f74c8ab5e6416dc35a577aa">m_iFilterOrder</a>;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    }</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno"><a class="line" href="a05775.html#a39d3e28ceef2b9c77e44a2a47a6f70fc">  506</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#a39d3e28ceef2b9c77e44a2a47a6f70fc">NoiseReduction::setFilterActive</a>(<span class="keywordtype">bool</span> state)</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;{</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    m_bFilterActivated = state;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;}</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno"><a class="line" href="a05775.html#a133ab26186acaa1c6c91f2c2b635fd2d">  514</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#a133ab26186acaa1c6c91f2c2b635fd2d">NoiseReduction::initSphara</a>()</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;{</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="comment">//Load SPHARA matrix</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    IOUtils::read_eigen_matrix(m_matSpharaVVGradLoaded, QString(QCoreApplication::applicationDirPath() + <span class="stringliteral">&quot;/resources/mne_scan/plugins/noisereduction/SPHARA/Vectorview_SPHARA_InvEuclidean_Grad.txt&quot;</span>));</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    IOUtils::read_eigen_matrix(m_matSpharaVVMagLoaded, QString(QCoreApplication::applicationDirPath() + <span class="stringliteral">&quot;/resources/mne_scan/plugins/noisereduction/SPHARA/Vectorview_SPHARA_InvEuclidean_Mag.txt&quot;</span>));</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    IOUtils::read_eigen_matrix(m_matSpharaBabyMEGInnerLoaded, QString(QCoreApplication::applicationDirPath() + <span class="stringliteral">&quot;/resources/mne_scan/plugins/noisereduction/SPHARA/BabyMEG_SPHARA_InvEuclidean_Inner.txt&quot;</span>));</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    IOUtils::read_eigen_matrix(m_matSpharaBabyMEGOuterLoaded, QString(QCoreApplication::applicationDirPath() + <span class="stringliteral">&quot;/resources/mne_scan/plugins/noisereduction/SPHARA/BabyMEG_SPHARA_InvEuclidean_Outer.txt&quot;</span>));</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    IOUtils::read_eigen_matrix(m_matSpharaEEGLoaded, QString(QCoreApplication::applicationDirPath() + <span class="stringliteral">&quot;/resources/mne_scan/plugins/noisereduction/SPHARA/Current_SPHARA_EEG.txt&quot;</span>));</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="comment">//Generate indices used to create the SPHARA operators for VectorView</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    m_vecIndicesFirstVV.resize(0);</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    m_vecIndicesSecondVV.resize(0);</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> r = 0; r &lt; m_pFiffInfo-&gt;chs.size(); ++r) {</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="comment">//Find gardiometers</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs.at(r).chpos.coil_type == 3012) {</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            m_vecIndicesFirstVV.conservativeResize(m_vecIndicesFirstVV.rows()+1);</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            m_vecIndicesFirstVV(m_vecIndicesFirstVV.rows()-1) = r;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        }</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="comment">//Find magnetometers</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs.at(r).chpos.coil_type == 3024) {</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            m_vecIndicesSecondVV.conservativeResize(m_vecIndicesSecondVV.rows()+1);</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            m_vecIndicesSecondVV(m_vecIndicesSecondVV.rows()-1) = r;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        }</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    }</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="comment">//Generate indices used to create the SPHARA operators for babyMEG</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    m_vecIndicesFirstBabyMEG.resize(0);</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> r = 0; r &lt; m_pFiffInfo-&gt;chs.size(); ++r) {</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <span class="comment">//Find inner layer</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs.at(r).chpos.coil_type == 7002) {</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            m_vecIndicesFirstBabyMEG.conservativeResize(m_vecIndicesFirstBabyMEG.rows()+1);</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;            m_vecIndicesFirstBabyMEG(m_vecIndicesFirstBabyMEG.rows()-1) = r;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        }</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="comment">//TODO: Find outer layer</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    }</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="comment">//Generate indices used to create the SPHARA operators for EEG layouts</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    m_vecIndicesFirstEEG.resize(0);</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> r = 0; r &lt; m_pFiffInfo-&gt;chs.size(); ++r) {</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="comment">//Find EEG</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        <span class="keywordflow">if</span>(m_pFiffInfo-&gt;chs.at(r).kind == FIFFV_EEG_CH) {</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            m_vecIndicesFirstEEG.conservativeResize(m_vecIndicesFirstEEG.rows()+1);</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            m_vecIndicesFirstEEG(m_vecIndicesFirstEEG.rows()-1) = r;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        }</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment">//    qDebug()&lt;&lt;&quot;NoiseReduction::createSpharaOperator - Read VectorView mag matrix &quot;&lt;&lt;m_matSpharaVVMagLoaded.rows()&lt;&lt;m_matSpharaVVMagLoaded.cols()&lt;&lt;&quot;and grad matrix&quot;&lt;&lt;m_matSpharaVVGradLoaded.rows()&lt;&lt;m_matSpharaVVGradLoaded.cols();</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">//    qDebug()&lt;&lt;&quot;NoiseReduction::createSpharaOperator - Read BabyMEG inner layer matrix &quot;&lt;&lt;m_matSpharaBabyMEGInnerLoaded.rows()&lt;&lt;m_matSpharaBabyMEGInnerLoaded.cols()&lt;&lt;&quot;and outer layer matrix&quot;&lt;&lt;m_matSpharaBabyMEGOuterFull.rows()&lt;&lt;m_matSpharaBabyMEGOuterFull.cols();</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;}</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno"><a class="line" href="a05775.html#a47bde8143e803d2a74151c547cb20723">  572</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#a47bde8143e803d2a74151c547cb20723">NoiseReduction::createSpharaOperator</a>()</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;{</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    qDebug()&lt;&lt;<span class="stringliteral">&quot;NoiseReduction::createSpharaOperator - Creating SPHARA oerpator for&quot;</span>&lt;&lt;m_sCurrentSystem;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    m_mutex.lock();</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    MatrixXd matSpharaMultFirst = MatrixXd::Identity(m_pFiffInfo-&gt;chs.size(), m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    MatrixXd matSpharaMultSecond = MatrixXd::Identity(m_pFiffInfo-&gt;chs.size(), m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="keywordflow">if</span>(m_sCurrentSystem == <span class="stringliteral">&quot;VectorView&quot;</span>) {</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        matSpharaMultFirst = Sphara::makeSpharaProjector(m_matSpharaVVGradLoaded, m_vecIndicesFirstVV, m_pFiffInfo-&gt;nchan, m_iNBaseFctsFirst, 1); <span class="comment">//GRADIOMETERS</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        matSpharaMultSecond = Sphara::makeSpharaProjector(m_matSpharaVVMagLoaded, m_vecIndicesSecondVV, m_pFiffInfo-&gt;nchan, m_iNBaseFctsSecond, 0); <span class="comment">//Magnetometers</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    }</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">if</span>(m_sCurrentSystem == <span class="stringliteral">&quot;BabyMEG&quot;</span>) {</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        matSpharaMultFirst = Sphara::makeSpharaProjector(m_matSpharaBabyMEGInnerLoaded, m_vecIndicesFirstBabyMEG, m_pFiffInfo-&gt;nchan, m_iNBaseFctsFirst, 0); <span class="comment">//InnerLayer</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    }</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">if</span>(m_sCurrentSystem == <span class="stringliteral">&quot;EEG&quot;</span>) {</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        matSpharaMultFirst = Sphara::makeSpharaProjector(m_matSpharaEEGLoaded, m_vecIndicesFirstEEG, m_pFiffInfo-&gt;nchan, m_iNBaseFctsFirst, 0); <span class="comment">//InnerLayer</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    }</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="comment">//Write final operator matrices to file</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">//    IOUtils::write_eigen_matrix(matSpharaMultFirst, QString(QCoreApplication::applicationDirPath() + &quot;resources/mne_scan/plugins/noisereduction/SPHARA/matSpharaMultFirst.txt&quot;));</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="comment">//    IOUtils::write_eigen_matrix(matSpharaMultSecond, QString(QCoreApplication::applicationDirPath() + &quot;resources/mne_scan/plugins/noisereduction/SPHARA/matSpharaMultSecond.txt&quot;));</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="comment">// Make operators sparse</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    qint32 nchan = this-&gt;m_pFiffInfo-&gt;nchan;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    qint32 i, k;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keyword">typedef</span> Eigen::Triplet&lt;double&gt; T;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    std::vector&lt;T&gt; tripletList;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    tripletList.reserve(nchan);</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="comment">//First operator</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    tripletList.clear();</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    tripletList.reserve(matSpharaMultFirst.rows()*matSpharaMultFirst.cols());</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; matSpharaMultFirst.rows(); ++i) {</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="keywordflow">for</span>(k = 0; k &lt; matSpharaMultFirst.cols(); ++k) {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">if</span>(matSpharaMultFirst(i,k) != 0) {</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                tripletList.push_back(T(i, k, matSpharaMultFirst(i,k)));</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            }</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        }</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    }</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    SparseMatrix&lt;double&gt; matSparseSpharaMultFirst = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">if</span>(tripletList.size() &gt; 0) {</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        matSparseSpharaMultFirst.setFromTriplets(tripletList.begin(), tripletList.end());</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    }</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">//Second operator</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    tripletList.clear();</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    tripletList.reserve(matSpharaMultSecond.rows()*matSpharaMultSecond.cols());</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; matSpharaMultSecond.rows(); ++i) {</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <span class="keywordflow">for</span>(k = 0; k &lt; matSpharaMultSecond.cols(); ++k) {</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            <span class="keywordflow">if</span>(matSpharaMultSecond(i,k) != 0) {</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                tripletList.push_back(T(i, k, matSpharaMultSecond(i,k)));</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            }</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        }</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    }</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    SparseMatrix&lt;double&gt;matSparseSpharaMultSecond = SparseMatrix&lt;double&gt;(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">if</span>(tripletList.size() &gt; 0) {</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        matSparseSpharaMultSecond.setFromTriplets(tripletList.begin(), tripletList.end());</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    }</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="comment">//Create full multiplication matrix</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    m_matSparseSpharaMult = matSparseSpharaMultFirst * matSparseSpharaMultSecond;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    m_matSparseFull = m_matSparseProjMult * m_matSparseCompMult;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    m_mutex.unlock();</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;}</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">//*************************************************************************************************************</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;</div><div class="line"><a name="l00654"></a><span class="lineno"><a class="line" href="a05775.html#ad887574c4d6f2b4e5215d7c4680c43fe">  654</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="a05775.html#ad887574c4d6f2b4e5215d7c4680c43fe">NoiseReduction::run</a>()</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;{</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="comment">// Wait for Fiff Info</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">while</span>(!m_pFiffInfo) {</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        msleep(10);<span class="comment">// Wait for fiff Info</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    }</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">//Read and create SPHARA operator for the first time</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    initSphara();</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    createSpharaOperator();</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">while</span>(m_bIsRunning)</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    {</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="comment">//Dispatch the inputs</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        MatrixXd t_mat = m_pNoiseReductionBuffer-&gt;pop();</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        m_mutex.lock();</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="comment">//Do SSP&#39;s and compensators here</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">if</span>(m_bCompActivated) {</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            <span class="keywordflow">if</span>(m_bProjActivated) {</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                <span class="comment">//Comp + Proj</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                t_mat = m_matSparseProjCompMult * t_mat;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                <span class="comment">//Comp</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                t_mat = m_matSparseCompMult * t_mat;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            }</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            <span class="keywordflow">if</span>(m_bProjActivated) {</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                <span class="comment">//Proj</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                t_mat = m_matSparseProjMult * t_mat;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                <span class="comment">//None - Raw</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            }</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        }</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <span class="comment">//Do temporal filtering here</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="keywordflow">if</span>(m_bFilterActivated) {</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            QList&lt;FilterData&gt; list;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            list &lt;&lt; m_filterData;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            t_mat = m_pRtFilter-&gt;filterDataBlock(t_mat,</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                                                            m_iMaxFilterLength,</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                                                            m_lFilterChannelList,</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                                                            list);</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;t_mat dim:&quot;&lt;&lt;t_mat.rows()&lt;&lt;&quot;x&quot;&lt;&lt;t_mat.cols();</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;m_lFilterChannelList.size():&quot;&lt;&lt;m_lFilterChannelList.size();</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment">//        qDebug()&lt;&lt;&quot;m_filterData.size():&quot;&lt;&lt;m_filterData.size();</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="comment">//Do SPHARA here</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="keywordflow">if</span>(m_bSpharaActive) {</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            <span class="comment">//Set bad channels to zero so they do not get smeared into</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; m_pFiffInfo-&gt;bads.size(); ++i) {</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                t_mat.row(m_pFiffInfo-&gt;ch_names.indexOf(m_pFiffInfo-&gt;bads.at(i))).setZero();</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;            }</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            t_mat = m_matSparseSpharaMult * t_mat;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        }</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment">//        //Common average</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">//        MatrixXd commonAvr = MatrixXd(m_pFiffInfo-&gt;chs.size(),m_pFiffInfo-&gt;chs.size());</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">//        commonAvr.setZero();</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">//        int nEEGCh = 0;</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">//        for(int i = 0; i &lt;m_pFiffInfo-&gt;chs.size(); ++i) {</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">//            if(m_pFiffInfo-&gt;chs.at(i).ch_name.contains(&quot;EEG&quot;) &amp;&amp; !m_pFiffInfo-&gt;bads.contains(m_pFiffInfo-&gt;chs.at(i).ch_name)) {</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment">//                nEEGCh++;</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment">//            }</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="comment">//        }</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="comment">//        for(int i = 0; i &lt;m_pFiffInfo-&gt;chs.size(); ++i) {</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="comment">//            for(int j = 0; j &lt; m_pFiffInfo-&gt;chs.size(); ++j) {</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment">//                if(m_pFiffInfo-&gt;chs.at(j).ch_name.contains(&quot;EEG&quot;) &amp;&amp; !m_pFiffInfo-&gt;bads.contains(m_pFiffInfo-&gt;chs.at(j).ch_name)) {</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="comment">//                    commonAvr(i,j) = 1/nEEGCh;</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment">//                }</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="comment">//            }</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="comment">//        }</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="comment">//        UTILSLIB::IOUtils::write_eigen_matrix(commonAvr, &quot;commonAvr.txt&quot;, &quot;common vaergae matrix&quot;);</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        m_mutex.unlock();</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        <span class="comment">//Send the data to the connected plugins and the online display</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        m_pNoiseReductionOutput-&gt;data()-&gt;setValue(t_mat);</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    }</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;}</div><div class="ttc" id="a03891_html_a59d3cc5600aa876c0f8bcfc3b31e4e65"><div class="ttname"><a href="a03891.html#a59d3cc5600aa876c0f8bcfc3b31e4e65">FIFFLIB::FiffCtfComp::data</a></div><div class="ttdeci">FiffNamedMatrix::SDPtr data</div><div class="ttdef"><b>Definition:</b> <a href="a00851_source.html#l00125">fiff_ctf_comp.h:125</a></div></div>
<div class="ttc" id="a05775_html_a133ab26186acaa1c6c91f2c2b635fd2d"><div class="ttname"><a href="a05775.html#a133ab26186acaa1c6c91f2c2b635fd2d">NOISEREDUCTIONPLUGIN::NoiseReduction::initSphara</a></div><div class="ttdeci">void initSphara()</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00514">noisereduction.cpp:514</a></div></div>
<div class="ttc" id="a05323_html"><div class="ttname"><a href="a05323.html">SCMEASLIB::RealTimeMultiSampleArray</a></div><div class="ttdoc">The RealTimeMultiSampleArrayNew class is the base class of every RealTimeMultiSampleArrayNew Measurem...</div><div class="ttdef"><b>Definition:</b> <a href="a02219_source.html#l00087">realtimemultisamplearray.h:87</a></div></div>
<div class="ttc" id="a02219_html"><div class="ttname"><a href="a02219.html">realtimemultisamplearray.h</a></div><div class="ttdoc">Contains the declaration of the RealTimeMultiSampleArray class. </div></div>
<div class="ttc" id="a03891_html"><div class="ttname"><a href="a03891.html">FIFFLIB::FiffCtfComp</a></div><div class="ttdoc">CTF software compensation data. </div><div class="ttdef"><b>Definition:</b> <a href="a00851_source.html#l00087">fiff_ctf_comp.h:87</a></div></div>
<div class="ttc" id="a04715_html"><div class="ttname"><a href="a04715.html">RTPROCESSINGLIB::RtFilter</a></div><div class="ttdoc">Real-time filtering. </div><div class="ttdef"><b>Definition:</b> <a href="a01484_source.html#l00090">rtfilter.h:90</a></div></div>
<div class="ttc" id="a05775_html"><div class="ttname"><a href="a05775.html">NOISEREDUCTIONPLUGIN::NoiseReduction</a></div><div class="ttdoc">The NoiseReduction class provides a tools to reduce noise of an incoming data stream. It then forwards the processed data to subsequent plugins. </div><div class="ttdef"><b>Definition:</b> <a href="a02855_source.html#l00126">noisereduction.h:126</a></div></div>
<div class="ttc" id="a05775_html_a47bde8143e803d2a74151c547cb20723"><div class="ttname"><a href="a05775.html#a47bde8143e803d2a74151c547cb20723">NOISEREDUCTIONPLUGIN::NoiseReduction::createSpharaOperator</a></div><div class="ttdeci">void createSpharaOperator()</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00572">noisereduction.cpp:572</a></div></div>
<div class="ttc" id="a03164_html"><div class="ttname"><a href="a03164.html">DISPLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="a00173_source.html#l00079">bar.h:79</a></div></div>
<div class="ttc" id="a00443_html"><div class="ttname"><a href="a00443.html">scalingview.h</a></div><div class="ttdoc">Declaration of the ScalingView Class. </div></div>
<div class="ttc" id="a05775_html_a39d3e28ceef2b9c77e44a2a47a6f70fc"><div class="ttname"><a href="a05775.html#a39d3e28ceef2b9c77e44a2a47a6f70fc">NOISEREDUCTIONPLUGIN::NoiseReduction::setFilterActive</a></div><div class="ttdeci">void setFilterActive(bool state)</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00506">noisereduction.cpp:506</a></div></div>
<div class="ttc" id="a03167_html"><div class="ttname"><a href="a03167.html">UTILSLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="a00317_source.html#l00078">filtersettingsview.h:78</a></div></div>
<div class="ttc" id="a04379_html"><div class="ttname"><a href="a04379.html">filterData</a></div><div class="ttdef"><b>Definition:</b> <a href="a01322_source.html#l00326">mne_raw_data.cpp:326</a></div></div>
<div class="ttc" id="a03182_html"><div class="ttname"><a href="a03182.html">RTPROCESSINGLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="a01466_source.html#l00080">rtave.h:80</a></div></div>
<div class="ttc" id="a04755_html"><div class="ttname"><a href="a04755.html">UTILSLIB::FilterData</a></div><div class="ttdef"><b>Definition:</b> <a href="a01523_source.html#l00098">filterdata.h:98</a></div></div>
<div class="ttc" id="a01484_html"><div class="ttname"><a href="a01484.html">rtfilter.h</a></div><div class="ttdoc">RtFilter class definition. </div></div>
<div class="ttc" id="a00461_html"><div class="ttname"><a href="a00461.html">spharasettingsview.h</a></div><div class="ttdoc">Declaration of the SpharaSettingsView Class. </div></div>
<div class="ttc" id="a02855_html"><div class="ttname"><a href="a02855.html">noisereduction.h</a></div><div class="ttdoc">Contains the declaration of the NoiseReduction class. </div></div>
<div class="ttc" id="a01541_html"><div class="ttname"><a href="a01541.html">sphara.h</a></div><div class="ttdoc">Declaration of the Sphara class. </div></div>
<div class="ttc" id="a05391_html_a8223ab9c31dbedbff2f257c2efd8c67b"><div class="ttname"><a href="a05391.html#a8223ab9c31dbedbff2f257c2efd8c67b">SCSHAREDLIB::PluginOutputData::create</a></div><div class="ttdeci">static QSharedPointer&lt; PluginOutputData&lt; T &gt; &gt; create(IPlugin *parent, const QString &amp;name, const QString &amp;descr)</div><div class="ttdef"><b>Definition:</b> <a href="a02312_source.html#l00126">pluginoutputdata.h:126</a></div></div>
<div class="ttc" id="a05351_html_addfb10f54b9f7aaed5a12ad5665d8b5d"><div class="ttname"><a href="a05351.html#addfb10f54b9f7aaed5a12ad5665d8b5d">SCSHAREDLIB::IPlugin::PluginType</a></div><div class="ttdeci">PluginType</div><div class="ttdef"><b>Definition:</b> <a href="a02255_source.html#l00100">IPlugin.h:100</a></div></div>
<div class="ttc" id="a03226_html"><div class="ttname"><a href="a03226.html">NOISEREDUCTIONPLUGIN</a></div><div class="ttdef"><b>Definition:</b> <a href="a02843_source.html#l00061">noisereductionaboutwidget.h:61</a></div></div>
<div class="ttc" id="a05775_html_ad887574c4d6f2b4e5215d7c4680c43fe"><div class="ttname"><a href="a05775.html#ad887574c4d6f2b4e5215d7c4680c43fe">NOISEREDUCTIONPLUGIN::NoiseReduction::run</a></div><div class="ttdeci">virtual void run()</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00654">noisereduction.cpp:654</a></div></div>
<div class="ttc" id="a00317_html"><div class="ttname"><a href="a00317.html">filtersettingsview.h</a></div><div class="ttdoc">Declaration of the FilterSettingsView Class. </div></div>
<div class="ttc" id="a05775_html_af02e1e61ff114b41ea03b2e568651c5c"><div class="ttname"><a href="a05775.html#af02e1e61ff114b41ea03b2e568651c5c">NOISEREDUCTIONPLUGIN::NoiseReduction::setFilterChannelType</a></div><div class="ttdeci">void setFilterChannelType(QString sType)</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00466">noisereduction.cpp:466</a></div></div>
<div class="ttc" id="a05299_html_ab0a022ec36c13e2f29d09aa4e08dc85d"><div class="ttname"><a href="a05299.html#ab0a022ec36c13e2f29d09aa4e08dc85d">SCMEASLIB::Measurement::SPtr</a></div><div class="ttdeci">QSharedPointer&lt; Measurement &gt; SPtr</div><div class="ttdef"><b>Definition:</b> <a href="a02183_source.html#l00070">measurement.h:70</a></div></div>
<div class="ttc" id="a03183_html"><div class="ttname"><a href="a03183.html">IOBUFFER</a></div><div class="ttdef"><b>Definition:</b> <a href="a01547_source.html#l00060">buffer.h:60</a></div></div>
<div class="ttc" id="a04783_html"><div class="ttname"><a href="a04783.html">IOBUFFER::CircularMatrixBuffer</a></div><div class="ttdoc">The circular matrix buffer. </div><div class="ttdef"><b>Definition:</b> <a href="a01562_source.html#l00100">circularmatrixbuffer.h:100</a></div></div>
<div class="ttc" id="a05771_html_a002b1b47fabdcea03a18b2272758ca87"><div class="ttname"><a href="a05771.html#a002b1b47fabdcea03a18b2272758ca87">NOISEREDUCTIONPLUGIN::NoiseReductionSetupWidget::NoiseReductionSetupWidget</a></div><div class="ttdeci">NoiseReductionSetupWidget(NoiseReduction *toolbox, QWidget *parent=0)</div><div class="ttdef"><b>Definition:</b> <a href="a02846_source.html#l00065">noisereductionsetupwidget.cpp:65</a></div></div>
<div class="ttc" id="a01583_html"><div class="ttname"><a href="a01583.html">ioutils.h</a></div><div class="ttdoc">IOUtils class declaration. </div></div>
<div class="ttc" id="a05379_html_ac8fc3f9ee35cd2c8336cadb3e7c6f5df"><div class="ttname"><a href="a05379.html#ac8fc3f9ee35cd2c8336cadb3e7c6f5df">SCSHAREDLIB::PluginInputData::create</a></div><div class="ttdeci">static QSharedPointer&lt; PluginInputData&lt; T &gt; &gt; create(IPlugin *parent, const QString &amp;name, const QString &amp;descr)</div><div class="ttdef"><b>Definition:</b> <a href="a02294_source.html#l00126">plugininputdata.h:126</a></div></div>
<div class="ttc" id="a05775_html_a2bc4d62aba9a93884af4da532620c885"><div class="ttname"><a href="a05775.html#a2bc4d62aba9a93884af4da532620c885">NOISEREDUCTIONPLUGIN::NoiseReduction::setFilter</a></div><div class="ttdeci">void setFilter(const UTILSLIB::FilterData &amp;filterData)</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00493">noisereduction.cpp:493</a></div></div>
<div class="ttc" id="a00257_html"><div class="ttname"><a href="a00257.html">compensatorview.h</a></div><div class="ttdoc">Declaration of the CompensatorView Class. </div></div>
<div class="ttc" id="a02849_html"><div class="ttname"><a href="a02849.html">noisereductionsetupwidget.h</a></div><div class="ttdoc">Contains the declaration of the NoiseReductionSetupWidget class. </div></div>
<div class="ttc" id="a05775_html_ad397190f9542af0984688a877b4dd952"><div class="ttname"><a href="a05775.html#ad397190f9542af0984688a877b4dd952">NOISEREDUCTIONPLUGIN::NoiseReduction::updateProjection</a></div><div class="ttdeci">void updateProjection(const QList&lt; FIFFLIB::FiffProj &gt; &amp;projs)</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00352">noisereduction.cpp:352</a></div></div>
<div class="ttc" id="a05771_html"><div class="ttname"><a href="a05771.html">NOISEREDUCTIONPLUGIN::NoiseReductionSetupWidget</a></div><div class="ttdoc">The NoiseReductionSetupWidget class provides the NoiseReduction configuration window. </div><div class="ttdef"><b>Definition:</b> <a href="a02849_source.html#l00081">noisereductionsetupwidget.h:81</a></div></div>
<div class="ttc" id="a04755_html_a7ab40d383f74c8ab5e6416dc35a577aa"><div class="ttname"><a href="a04755.html#a7ab40d383f74c8ab5e6416dc35a577aa">UTILSLIB::FilterData::m_iFilterOrder</a></div><div class="ttdeci">int m_iFilterOrder</div><div class="ttdef"><b>Definition:</b> <a href="a01523_source.html#l00205">filterdata.h:205</a></div></div>
<div class="ttc" id="a00419_html"><div class="ttname"><a href="a00419.html">projectorsview.h</a></div><div class="ttdoc">Declaration of the ProjectorsView Class. </div></div>
<div class="ttc" id="a05775_html_a696b993789870eb5a68065bd9d086f2c"><div class="ttname"><a href="a05775.html#a696b993789870eb5a68065bd9d086f2c">NOISEREDUCTIONPLUGIN::NoiseReduction::updateCompensator</a></div><div class="ttdeci">void updateCompensator(int to)</div><div class="ttdef"><b>Definition:</b> <a href="a02852_source.html#l00410">noisereduction.cpp:410</a></div></div>
<div class="ttc" id="a03204_html"><div class="ttname"><a href="a03204.html">SCMEASLIB</a></div><div class="ttdef"><b>Definition:</b> <a href="a02138_source.html#l00078">realtimeconnectivityestimatewidget.h:78</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Dec 18 2019 19:35:42
</small></address>
</body>
</html>